const admin = require('firebase-admin');
process.env.GOOGLE_APPLICATION_CREDENTIALS = Runtime.getAssets()['/firebase-credentials.json'].path;
const { escondeNumero, limpaNumero, getDDD, sendNotification, convertNewLine, fillParams } = require(Runtime.getFunctions()['util'].path);

if (!admin.apps.length) {
  admin.initializeApp({}); 
} else {
  admin.app();
}
const firestore = admin.firestore();
const md5 = require('md5');

/*
    event: evento, token, from
*/
exports.handler = async function(context, event, callback) {
    let participanteId = await md5(limpaNumero(event.from));

    // Registrar participante na base geral
    await firestore.collection('participantes')
        .doc(participanteId).set({
            phoneNumber: limpaNumero(event.from),
            profileName: event.profileName,
            ultimoEvento: event.evento,
            updatedAt: admin.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    
    let participanteGeral = await firestore.collection('participantes')
        .doc(participanteId).get().then(async s => {
            if (s.exists) {
                return s.data();
            } else {
                return {}
            }
    });

    let participante = await firestore.collection('events')
        .doc(event.evento).collection('participantes')
        .doc(participanteId).get().then(async s => {
        if (s.exists) {
            return s.data();
        } else {
            await firestore.collection('events')
                .doc(event.evento).collection('participantes')
                .doc(participanteId).set({
                    createdAt: admin.firestore.FieldValue.serverTimestamp(),
                    phoneNumber: limpaNumero(event.from),
                    profileName: event.profileName,
                    pontosAcumulados: 0,
                    pontosCorrente: 0,
                    recebeuOptin: false,
                    ativouNetworking: false,
                    impressoesNetworking: 0
                });
            return {
                pontosAcumulados: 0,
                pontosCorrente: 0,
                recebeuOptin: false,
                ativouNetworking: false,
                impressoesNetworking: 0
            };
        }
    });

    let agendamentoTotal = null;
    let agendamentoPosicao = null;


    // TODO: verificar opt-in
    // /events/{eventId}/participantes/{participanteId}/ [recebeuOptin, aceitouOptin]
    // data.recebeuOptin = participante.recebeuOptin || false;


    // Verificar se tem agendamento de foto profissional, posi√ß√£o na fila e tempo
    // /events/{eventId}/agendamento/{participanteId}
    let agendamento = await firestore.collection('events')
        .doc(event.evento).collection('agendamento')
        .doc(participanteId).get().then( s => {
            if (s.exists) {
                return s.data();
            } else {
                return null;
            }
    });

    if (agendamento) {
        agendamentoTotal = await firestore.collection('events')
            .doc(event.evento).collection('agendamento')
            .get().then(s => {
                return s.size;
        });
            
        agendamentoPosicao = await firestore.collection('events')
            .doc(event.evento).collection('agendamento')
            .where('posicao', '<', agendamento.posicao)
            .get().then(s => {
                return s.size + 1;
        });
        agendamento.posicao = agendamentoPosicao;
    }
    
    let data = {
        participante: {
            ...participante,
            twilion: participanteGeral.twilion,
            isAdmin: participanteGeral.twilion || participanteGeral.isAdmin,
            gerenciaSorteio: participanteGeral.gerenciaSorteio,
            videomatikUnlimited: participanteGeral.videomatikUnlimited
        },
        agendamento,
        agendamentoPosicao,
        agendamentoTotal
    };

    let mensagem = [];

    switch (event.evento) {
        case 'tdcbusiness':
        
            mensagem.push(`Boas-vindas da Twilio!`);
            // Resumo de pontos
            if (participante.pontosCorrente > 0 ) {
                mensagem.push(`Voc√™ acumulou ${participante.pontosAcumulados} pontos e ainda pode trocar *${participante.pontosCorrente} pontos* no estande da Twilio.`);
            } else {
                if (participante.pontosAcumulados == 0) {
                    mensagem.push(`Voc√™ pode acumular pontos e trocar por brindes da Twilio.\nFa√ßa networking utilizando nossa ferramenta!`);
                } else {
                    mensagem.push(`Voc√™ j√° acumulou e gastou ${participante.pontosAcumulados} pontos.`)
                }
            }

            if (participanteGeral.videomatikUnlimited) {
                mensagem.push(`‚úÖ Videomatik *ILIMITADO!* ‚úÖ`);
                
            } else {
                mensagem.push(`Se voc√™ deseja criar um *v√≠deo din√¢mico* do TDC pela Videomatik, basta enviar uma foto diretamente por aqui.`)
            }

            // Comandos para Twilions
            if (participanteGeral.twilion) {
                mensagem.push([
                    `üö® *TWILION* üö®`,
                    `Envie *BRINDE* para trocar pontos de participante.`
                ].join('\n'));
            }

            // Comandos para equipe TDC
            if (participanteGeral.gerenciaSorteio) {
                mensagem.push([
                    `üö® *SORTEIO STADIUM* üö®`,
                    `Envie *SORTEIO* para gerenciar algum sorteio.`
                ].join('\n'));

            }

            // mensagem.push('Envie *ROGADX* para participar do sorteio!');

            // TDC Business
            mensagem.push('');
            mensagem.push(`O que voc√™ deseja fazer hoje?`);

            if (agendamento) {
                if (agendamento.status == 'fila') {
                    mensagem.push(`1. Sair da fila de foto profissional.\n(voc√™ est√° em *${agendamentoPosicao}¬∫ lugar*)`);
                } else {
                    mensagem.push(`1. Sair da fila de foto profissional.\n(atendimento em andamento)`);
                }
            } else {
                mensagem.push(`1. Entrar na fila de foto profissional. ${agendamentoTotal && agendamentoTotal > 0 ? agendamentoTotal + ' pessoa(s) na fila.' : '*SEM FILA!* '}`);
            }

            // if (!participante.ativouNetworking) {
                mensagem.push(`2. Participar do Networking Premiado da Twilio.`);
            // }

            mensagem.push(`3. Enviar foto para gerar v√≠deo din√¢mico.`);

            mensagem.push(`Envie o *n√∫mero* da op√ß√£o desejada.`);
            mensagem.push(`Voc√™ tamb√©m pode enviar uma foto para gerar um v√≠deo.`)
            break;
        case 'conarec':
        case 'hacktown':
            // Carregar dados de vendingmachine
            // {{widgets.verifica-participante.parsed.vendingmachine.codigos}}
            let vendingmachine = await firestore.collection('vendingmachine')
                .doc(process.env.VENDINGMACHINE_DEFAULT).collection('estoque').get().then(s => {

                    return {
                        codigos: s.docs.map(d => d.id),
                        items: s.docs.reduce((prev, current) => {
                            // console.log('CURR', current.id, '>', current.data());
                            prev[current.id] = current.data();
                            return prev;
                        }, {})
                    };
            });
            // console.log('VENDING MACHINE', vendingmachine);
            data.vendingmachine = vendingmachine;
        
            break;
    }
    
    data.mensagem = mensagem.join('\n\n');

    // TODO: verifica palavras-chave de sorteios em aberto
    








    // TODO: verificar pontua√ß√£o de networking
    // /events/{eventId}/participantes/{participanteId}/ [PontosAcumulados, PontosCorrente]
    // como resoler pontua√ß√£o igual?

    // TODO: montar mensagem padr√£o para participante com resumo das informa√ß√µes



    // console.log('VERIFICA PALAVRA: ', event);

    // const client = await context.getTwilioClient();
    // if (!event.token) {
    //     console.log('TOKEN VAZIO');
    //     return callback(null, {
    //         type: 'not-found'
    //     });
    // }

    // let activation = await firestore.collection('events').doc(event.evento).collection('palavras').doc(event.token).get();
    // if (!activation.exists) {
    //     activation = await firestore.collection('events').doc(event.evento).collection('palavras').doc(event.token.toLowerCase()).get();
    //     if (!activation.exists) {
    //         // token n√£o encontrado
    //         console.log(event.token, 'Palavra n√£o existe no evento', event.evento);
    //         return callback(null, {
    //             type: 'not-found'
    //         });
    //     }
    // }

    console.log('DATA', data);
    

    callback(null, data);

};
